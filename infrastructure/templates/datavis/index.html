<!DOCTYPE HTML>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Visualization Platform</title>
		<link rel="stylesheet" type="text/css" href="content/css/datavis.css" media="screen">
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js" type="text/javascript"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js" type="text/javascript"></script>
		<script src="content/js/highstock.js" type="text/javascript"></script>
		
		<script type="text/javascript">
		$(function() {
			var seriesOptions = [],
				yAxisOptions = [],
				seriesCounter = 0,
				symbol,
				colors = Highcharts.getOptions().colors;

				{% if symbol == '' %}
				symbol = 'EBAY';
				{% else %}
				symbol = '{{ symbol }}';
				{% endif %}
				
				names = [symbol, 'MA', 'MACD'];
				
				var xValue = [];
				var yValue = [];
				var mValue = [];
				var dValue = [];

				{% for date in dates %}
				xValue.push({{ date }});
				{% endfor %}

				{% for price in prices %}
				yValue.push(parseFloat({{ price }}));
				{% endfor %}

				{% for ma in ma20 %}
				mValue.push(parseFloat({{ ma }}));
				{% endfor %}
				
				{% for mac in macd %}
				dValue.push(parseFloat({{ mac }}));
				{% endfor %}
				
				var data = [];
				for (var i = 0; i < xValue.length; i++) { 
					data.push([xValue[i],yValue[i]]);
				}
				
				var mav = [];
				for (var i = 0; i < xValue.length; i++) { 
					mav.push([xValue[i],mValue[i]]);
				}
				
				var macd = [];
				for (var i = 0; i < xValue.length; i++) { 
					macd.push([xValue[i],dValue[i]]);
				}
				
				seriesOptions[0] = {
					name: names[0],
					data: data
				};
				
				seriesOptions[1] = {
					name: names[1],
					data: mav
				};
				
				seriesOptions[2] = {
					name: names[2],
					data: macd,
					yAxis: 1
				};
								
				createChart();
				
			// create the chart when all data is loaded
			function createChart() {
		
				chart = new Highcharts.StockChart({
				    chart: {
				        renderTo: 'container'
				    },
				
					title : {
						text : symbol + ' Stock Price'
					},
							
					credits: {
				        enabled: false
				    },
				
				    scrollbar: {
			            enabled: false
			        },
			    
				    rangeSelector: {
				        selected: 2
				    },
		
				    yAxis: [{
				    	labels: {
				    		formatter: function() {
				    			return (this.value > 0 ? '+' : '') + this.value + '%';
				    		}
				    	},
				    	plotLines: [{
				    		value: 0,
				    		width: 2,
				    		color: 'silver'
						}],
					    height: 200
					    }, {
				    	top: 300,
					    height: 100
					}],
				    
				    plotOptions: {
				    	series: {
							animation: {
			                    duration: 4000,
			                    easing: 'swing'
							},
				    		compare: 'value'
				    	}
				    },
				
				    tooltip: {
				    	pointFormat: '<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b> ({point.change}%)<br/>',
				    	yDecimals: 2
				    },
				    
				    series: seriesOptions
				});
			}
		
		});
		</script>

		<script language="JavaScript">
		    $(document).ready(function() {
		        $('#stock').submit(function() {
		            $.ajax({
		                data: $(this).serialize(), 
		                type: 'POST', 
		                url: '/', 
		                success: function(response) {
		                    $('#container').html(response); 
		                }
		            });
		            return false;
		        });
		    });
		</script>	
	</head>
	<body>
		<div id="container" style="height: 600px; min-width: 600px"></div>
		<form action="" id="stock" method="post">{% csrf_token %} 
		<center>
			<table>
				<tr>
					<th>Symbol:</th><th><input type="text" name="symbol"></th>
					<th><button class="button" type="submit" value="Symbol">Refresh</button></th>
				</tr>
				<tr>
					<th>Predicted Next Day:</th><th>{{ projection }}</th>
				</tr>
			</table>
		</center>
		</form>
	</body>
</html>
